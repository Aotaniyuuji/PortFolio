<div class="container">
  <div class="row">

    <!--ジャンルリストの部分テンプレート-->
    <%= render "bygenre", genres: @genres %>
    <div class="col-md-8 mx-auto">
      <header class="article-header entry-header">
        <h2 class="mt-5 text-center"><%= @game.name %></h2>

        <!--フラッシュメッセージ-->
        <% if flash[:success].present? %>
          <div class="alert alert-success">
             <%= flash[:success] %><button type="button" class="close" data-dismiss="alert">&times;</button>
          </div>
        <% end %>
        <% if flash[:danger].present? %>
          <div class="alert alert-danger"><button type="button" class="close" data-dismiss="alert">&times;</button>
            <%= flash[:danger] %>
          </div>
        <% end %>

        <div class="mt-5 text-center">
          <h5>ジャンル：<%= @game.genre.name %></h5>
          <p><%= @game.explanation %></p>
          <div id="average_star_<%= @game.id %>">
            <p>レビュー<%= @game.reviews.count %>件</p>
          </div>
          <script>
            $(document).on('turbolinks:load', function() {
              let elem = document.querySelector('#average_star_<%= @game.id%>');
              if (elem == null) return;

              elem.innerHTML = ""
              let opt = {
                starOn: "<%= asset_path('star-on.png') %>",
                starOff: "<%= asset_path('star-off.png') %>",
                starHalf: "<%= asset_path('star-half.png') %>",
                half: true,
                readOnly: true,
                score: <%= @game.reviews.average(:star).to_f.round(1) %>,
                 //↑ 平均点を算出し、round関数で切り上げる
              };
              raty(elem, opt);
            });
          </script>
        </div>
      </header>

      <div class="col-md-8 mx-auto mt-5 text-center">
        <%# if current_user.reviews.nil? %>
          <%= form_with model: [@game, @review] do |f| %>
            <div class="form-group">
              <%= f.label :title, "レビュータイトル" %>
              <%= f.text_field :title, placeholder: "タイトル" %>
            </div>
            <div class="form-group">
              <%= f.label :comment, "レビューコメント" %>
              <%= f.text_area :comment, rows: '3',placeholder: "コメント" %><br>
            </div>
            <% if @review.id.nil? %>
              <div class="form-group" id="star">
                <%= f.label :star, "評価" %>
                <%= f.hidden_field :star, id: :review_star, class: 'form-control' %>
                <span id="post_raty"></span>
              </div>
              <script>
                $(document).on('turbolinks:load', function() {
                  let elem = document.querySelector('#post_raty');
                  if (elem == null) return;

                  elem.innerHTML = ""
                  let opt = {
                    starOn: "<%= asset_path('star-on.png') %>",
                    starOff: "<%= asset_path('star-off.png') %>",
                    starHalf: "<%= asset_path('star-half.png') %>",
                    scoreName: 'review[star]',
                  };
                  raty(elem, opt);
                });
              </script>
            <% end %>
            <div class="form-group">
              <%= f.submit "送信する", class: 'btn btn-primary' %>
            </div>
          <% end %>
        <%# end %>
      </div>

      <h4 class="p-3 border-bottom border-primary border-3">コメント一覧</h4>
      <% @game.reviews.each do |review| %>
      <table class="table table-bordered">
        <tr>
          <div class="mt-5 text-center">
            <p><%= review.user.name %></p>
            <%= review.title %>
            <%= review.comment %>
            <div id="star-rate<%= review.id %>"></div>
            <script>
                $(document).on('turbolinks:load', function() {
                  let elem = document.querySelector('#star-rate<%= review.id %>');
                  if (elem == null) return;

                  elem.innerHTML = ""
                  let opt = {
                    starOn: "<%= asset_path('star-on.png') %>",
                    starOff: "<%= asset_path('star-off.png') %>",
                    starHalf: "<%= asset_path('star-half.png') %>",
                    score: <%= review.star %>,
                    readOnly: true
                  };
                  raty(elem, opt);
                });
              </script>
            <% if review.user == current_user %>
              <%= link_to game_review_path(review.game, review), method: :delete, data: { confirm: "本当に削除してもよろしいですか？" } do %>
                <button class="btn btn-danger">削除</button>
              <% end %>
            <% end %>
          </div>
        </tr>
      </table>
      <% end %>
    </div>
  </div>
</div>
